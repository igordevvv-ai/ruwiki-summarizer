from typing import Tuple

from .parse import count_words


def decide_sentence_bounds(section_text: str) -> Tuple[int, int]:
    """На основе длины раздела в словах задаем диапазон числа предложений в конспекте. """
    length = count_words(section_text)

    if length < 80:
        return 1, 2
    elif length <= 150:
        return 2, 3
    else:
        return 3, 4


def build_intro_prompts(intro_text: str, min_sent: int, max_sent: int) -> Tuple[str, str]:
    """
    Формируем system и user промпты для переработки вступления
    (без заголовка, только текст).
    """
    system_prompt = (
        "Ты — редактор Рувики. "
        "Твоя задача — переписать вступление статьи простым и понятным русским языком "
        "для школьника 7–9 класса. "
        "Сохраняй нейтральный, энциклопедический стиль. "
        "Не используй обращения к читателю и местоимения 'я', 'ты', 'вы'. "
        "Не придумывай новых фактов, примеров и числовых значений — используй только информацию из исходного текста.\n\n"
        "КАТЕГОРИЧЕСКИ запрещено:\n"
        "- добавлять новые числа, даты, проценты, диапазоны, величины, годы;\n"
        "- округлять числа;\n"
        "- придумывать количественные характеристики.\n\n"
        "Разрешено использовать только те числа, которые дословно присутствуют в исходном тексте именно этого фрагмента. "
        "Если во вступлении нет чисел — не используй числа совсем.\n\n"
        f"Сократи вступление так, чтобы получилось строго не меньше {min_sent} и не больше {max_sent} коротких предложений. "
        "Не добавляй заголовки."
    )

    user_prompt = (
        "Ниже дан текст вступления статьи Рувики.\n"
        f"Перепиши его для школьника 7–9 класса, сохранив смысл, но упростив формулировки.\n"
        f"Сделай строго не меньше {min_sent} и не больше {max_sent} предложений."
        "Не добавляй новых фактов и примеров.\n\n"
        "Исходный текст вступления:\n"
        "---------------------\n"
        f"{intro_text}\n"
        "---------------------\n"
    )

    return system_prompt, user_prompt


def build_section_prompts(
    section_title: str,
    section_text: str,
    min_sent: int,
    max_sent: int,
) -> Tuple[str, str]:
    """
    Формируем system и user промпты для каждого раздела статьи.
    Модель переписывает только содержимое раздела, заголовок остается тем же
    и добавляется на этапе сборки конспекта в пайплайне.
    """
    system_prompt = (
        "Ты — редактор Рувики. "
        "Твоя задача — переписать раздел статьи простым и понятным русским языком для школьника 7–9 класса. "
        "Сохраняй нейтральный, энциклопедический стиль. "
        "Не используй обращения к читателю и местоимения 'я', 'ты', 'вы'. "
        "Не придумывай новых фактов, примеров, сущностей и числовых значений — используй только информацию из исходного текста раздела.\n\n"
        "КАТЕГОРИЧЕСКИ запрещено:\n"
        "- добавлять новые числа, даты, проценты, диапазоны, величины, годы;\n"
        "- округлять числа;\n"
        "- придумывать количественные характеристики.\n\n"
        "Разрешено использовать только те числа, которые дословно присутствуют в исходном тексте именно этого фрагмента. "
        "Если во вступлении нет чисел — не используй числа совсем.\n\n"
        f"Сократи вступление так, чтобы получилось строго не меньше {min_sent} и не больше {max_sent} коротких предложений. "
        "Не добавляй заголовок раздела — только сам текст."
    )

    user_prompt = (
        f"Ниже дан текст раздела статьи Рувики с заголовком '{section_title}'.\n"
        "Перепиши этот раздел для школьника 7–9 класса, сохранив только ключевые факты и смысл.\n"
        f"Сделай строго не меньше {min_sent} и не больше {max_sent} предложений."
        "Не добавляй новых фактов, примеров и чисел.\n"
        "Не пиши заголовок раздела, только текст.\n\n"
        "Исходный текст раздела:\n"
        "---------------------\n"
        f"{section_text}\n"
        "---------------------\n"
    )

    return system_prompt, user_prompt